{% extends "base.html" %}

{% block title %}Import Data - LLM Leaderboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1 class="mb-4">
            <i class="fas fa-upload text-success"></i>
            Import Data
        </h1>
        
        <!-- Main Import Section -->
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-file-excel"></i> Import Excel/CSV Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Supported formats:</strong> Excel (.xlsx) and CSV (.csv) files with quality scores (1-10 scale)
                        </div>
                        
                        <form id="importForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Select File</label>
                                <input type="file" class="form-control" id="fileInput" name="file" accept=".xlsx,.csv" required>
                                <div class="form-text">Maximum file size: 50MB</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="computeMetrics" name="compute_metrics" checked>
                                    <label class="form-check-label" for="computeMetrics">
                                        Compute additional metrics (automatic processing)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-upload"></i> Start Import
                                </button>
                            </div>
                        </form>
                        
                        <div id="importResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Expected Format Section -->
        <div class="row mt-4">
            <div class="col-md-10 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-table"></i> Expected File Format</h6>
                    </div>
                    <div class="card-body">
                        <p>Your Excel/CSV file should contain the following columns:</p>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Column</th>
                                        <th>Required</th>
                                        <th>Description</th>
                                        <th>Example</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>task_id</code></td>
                                        <td class="text-success">Yes</td>
                                        <td>Unique identifier for the task</td>
                                        <td>language_tasks_001, logical_reasoning_004</td>
                                    </tr>
                                    <tr>
                                        <td><code>task_name</code></td>
                                        <td class="text-success">Yes</td>
                                        <td>Descriptive name for the task</td>
                                        <td>Countries ending in "lia", Pangram creation</td>
                                    </tr>
                                    <tr>
                                        <td><code>prompt_text</code></td>
                                        <td class="text-success">Yes</td>
                                        <td>Input prompt text</td>
                                        <td>Write a haiku where the second letter...</td>
                                    </tr>
                                    <tr>
                                        <td><code>task_group</code></td>
                                        <td class="text-success">Yes</td>
                                        <td>Category for grouping from config</td>
                                        <td>language_tasks, logical_reasoning, programming</td>
                                    </tr>
                                    <tr>
                                        <td><code>model_key</code></td>
                                        <td class="text-success">Yes</td>
                                        <td>Model identifier from configuration</td>
                                        <td>llm-001, llm-002, llm-003</td>
                                    </tr>
                                    <tr>
                                        <td><code>quality_score</code></td>
                                        <td class="text-success">Yes</td>
                                        <td>Human evaluation score (0-10)</td>
                                        <td>0, 5.5, 8.5, 10</td>
                                    </tr>
                                    <tr>
                                        <td><code>output_text</code></td>
                                        <td class="text-muted">Optional</td>
                                        <td>Model's response</td>
                                        <td>Once upon a time...</td>
                                    </tr>
                                    <tr>
                                        <td><code>tokens</code></td>
                                        <td class="text-muted">Optional</td>
                                        <td>Token count of response</td>
                                        <td>150, 320, 75</td>
                                    </tr>
                                    <tr>
                                        <td><code>language</code></td>
                                        <td class="text-muted">Optional</td>
                                        <td>Language code</td>
                                        <td>en, hu, de</td>
                                    </tr>
                                    <tr>
                                        <td><code>tags</code></td>
                                        <td class="text-muted">Optional</td>
                                        <td>Comma-separated tags</td>
                                        <td>creative,fiction,story</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Note:</strong> Quality scores should be between 0-10. Other metrics (ROUGE-L, BERTScore) are no longer automatically calculated.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Imports Section -->
        <div class="row mt-4">
            <div class="col-md-10 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-history"></i> Recent Imports</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Import history will be displayed here.</p>
                        <!-- This could be enhanced later to show recent import logs -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('importForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const resultDiv = document.getElementById('importResult');
    const submitButton = document.querySelector('button[type="submit"]');
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Processing file, please wait...</div>';
    
    fetch('/api/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> <strong>Import completed successfully!</strong>
                    <hr>
                    <div class="row">
                        <div class="col-4 text-center">
                            <h5 class="text-success">${data.tasks_inserted || 0}</h5>
                            <small>Tasks</small>
                        </div>
                        <div class="col-4 text-center">
                            <h5 class="text-success">${data.outputs_inserted || 0}</h5>
                            <small>Outputs</small>
                        </div>
                        <div class="col-4 text-center">
                            <h5 class="text-success">${data.metrics_inserted || 0}</h5>
                            <small>Metrics</small>
                        </div>
                    </div>
                    <div class="mt-2">
                        <a href="{{ url_for('index') }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-list"></i> View Leaderboard
                        </a>
                    </div>
                </div>
            `;
            
            // Reset form
            document.getElementById('importForm').reset();
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Import failed!</strong>
                    <br><br>
                    <strong>Error:</strong> ${data.error}
                    <br><br>
                    <small>Please check your file format and try again.</small>
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> <strong>Network error!</strong>
                <br><br>
                <strong>Error:</strong> ${error.message}
            </div>
        `;
    })
    .finally(() => {
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-upload"></i> Start Import';
    });
});

// File input validation
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const resultDiv = document.getElementById('importResult');
    
    if (file) {
        const maxSize = 50 * 1024 * 1024; // 50MB
        const allowedTypes = ['.xlsx', '.csv'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (file.size > maxSize) {
            resultDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> File size exceeds 50MB limit.</div>';
            e.target.value = '';
            return;
        }
        
        if (!allowedTypes.includes(fileExtension)) {
            resultDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Only .xlsx and .csv files are allowed.</div>';
            e.target.value = '';
            return;
        }
        
        // Clear any previous messages
        resultDiv.innerHTML = '';
    }
});
</script>
{% endblock %}